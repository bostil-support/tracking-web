@model Tracking.Web.Models.ViewModel.SurveyViewModel

@{
    ViewData["Title"] = "Survey";
    Layout = "~/Views/Shared/_SurveyLayout.cshtml";
}
@*<script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>*@
<link href="~/css/bootstrap-datetimepicker.css" rel="stylesheet" />
<div class="big-label">
    <h2>
        Elenco rilievi/azioni di mitigazione
    </h2>
</div>

<div class="main-content">
    <div class="card">
        <div class="card-header">Dati rilievo</div>
        <div class="card-item">
            <div>Severità</div>
            <div class="bold">@Model.SurveySeverity</div>
        </div>
        <div class="card-item">
            <div>Titolo</div>
            <div class="bold">@Model.Title</div>
            <div>ID</div>
            <div class="bold">@Model.Id</div>
        </div>
        <div class="card-item">
            <div>Utente Censimento</div>
            <div class="bold">@Model.UserName</div>
            <div>Validatore</div>
            <div class="bold">@Model.ValidatorAttribute</div>
        </div>
        <div class="card-item description">
            <div>Descrizione</div>
            <div class="bold full-line">
                @Model.Description
            </div>
        </div>
        <div class="edit-container">
            <img src="~/images/edit.png" alt="edit">
        </div>
    </div>

    <div class="card">
        <div class="card-header">Legal entity</div>
        <div class="card-item">
            <div>Denom. Legal Entity</div>
            <div class="bold">@Model.LegalEntity.Name</div>
            <div>Cod. Legal Entity</div>
            <div class="bold">@Model.LegalEntity.Id</div>
        </div>
        <div class="edit-container">
            <img src="~/images/edit.png" alt="edit">
        </div>
    </div>

    <div class="card">
        <div class="card-header">Normativa</div>
        <div class="card-item">
            <div>Titolo</div>
            <div class="bold">@Model.SrepCluster</div>
            <div>Area normativa</div>
            <div class="bold">@Model.ScrepArea</div>
        </div>
        <div class="edit-container">
            <img src="~/images/edit.png" alt="edit">
        </div>
    </div>

    <div class="card">
        <div class="card-header">Azione di mitigazione</div>
        <div class="card-item">
            <div>Owner</div>
            <div class="bold">@Model.ActionOwner</div>
        </div>
        <div class="card-item description">
            <div>Descrizione</div>
            <div class="bold full-line">
                @Model.ActionDescription
            </div>
        </div>
        <div class="edit-container">
            <img src="~/images/edit.png" alt="edit">
        </div>
    </div>

    <div class="controls">
        <div class="bold">Stato</div>
        <select asp-for="StatusId" asp-items="@Model.Statuses"></select>

        <div class="bold">Nuova Data Scadenza</div>
        <input type="date" id="dueDateLocal" asp-for="DueDateLocal">

        <div class="bold align-top">Storico note</div>

        <div class="notes full-line" id="notesList"></div>
        @*@Html.Partial("Notes", Model.Notes)*@
        @Html.Partial("AddNotePartial", Model.Note)

        <div class="button-container">
            <input type="button" value="ANNULLA" id="annulla">
            <input type="button" class="primary" value="SALVA" id="salva">
        </div>
    </div>
    @*<div class="input-group date">
        <input type="text" class="form-control" id="secondDate" value="@DateTime.Today.ToString("dd.MM.yyyy")" />
        <span class="input-group-addon">
            <i class="fa fa-calendar" aria-hidden="true"></i>
        </span>
    </div*@>
</div>
@section scripts{
    <script>
        window.onload = function () {
            $('#fileName').children().remove();
            $('textarea').val('');
            $('textarea').attr("placeholder", "Note").val('');

            GetNotes();

            $('#surveyId').val(@Model.Id);
        }
        $(function () {
            $('.date').datetimepicker({ locale: 'ru', debug: false, format: 'DD.MM.YYYY' });
        });
        $('#attachfile').change(function (e) {
            var fileName = e.target.files[0].name;
            $('#fileName').append('<div class="blue"> ' + fileName + '</div>');
        });

        $('#annulla').click(function () {
            $('#fileName').children().remove();
            $('textarea').val('');
            $('textarea').attr("placeholder", "Note").val('');
        });

        $('#salva').click(function () {


        });

        var dueDateOriginal;
        $('#dueDateLocal').change(function () {
             dueDateOriginal = document.getElementById('dueDateLocal').value;
             console.log(dueDateOriginal);
        });

        function CreateNote() {
            var form = $("#formNote");
            var formData = new FormData();
            formData.append('Description', $('textarea').val());
            formData.append('File', $('#attachfile')[0].files[0]);
            formData.append('SurveyId', @Model.Id);
            formData.append('Description', $('textarea').val());
            formData.append('SurveyId', @Model.Id);

            $.ajax({
                type: "POST",
                url: "/Home/AddNote",
                processData: false,
                contentType: false,
                data: formData,
                success: GetNotes
            })
        }

        function GetNotes() {
            $.ajax({
                url: "/Home/Notes?id=" + @Model.Id,
                type: "Get",
                success: GetAllNotesSuccess
            })
        }

        function GetAllNotesSuccess(data) {
            $('#notesList').html(data);
            $('#fileName').children().remove();
            $('textarea').val('');
            $('textarea').attr("placeholder", "Note").val('');
        }

        $('img[class="plus"]').click(function () {

        });
    </script>
}
